name: Nightly Build & Test

on:
  schedule:
    # Run every night at 3 AM UTC
    - cron: "0 3 * * *"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full
  ENCRYPTION_KEY: "01234567890123456789012345678901"

jobs:
  # ============================================================================
  # Full Test Matrix
  # ============================================================================
  full-test-matrix:
    name: ðŸŒ™ Full Test - ${{ matrix.os }} / Rust ${{ matrix.rust }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: ["1.80.0", "stable", "nightly"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust ${{ matrix.rust }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev protobuf-compiler
          protoc --version
          echo "PROTOC=$(which protoc)" >> $GITHUB_ENV

      - name: Install Protoc (Windows)
        if: runner.os == 'Windows'
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Protoc (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/
            ~/.cargo/git/
            apps/core/target/
          key: ${{ runner.os }}-${{ matrix.rust }}-cargo-nightly-${{ hashFiles('**/Cargo.lock') }}

      - name: Run all tests
        run: cargo test --manifest-path apps/core/Cargo.toml --all-features -- --nocapture
        continue-on-error: ${{ matrix.rust == 'nightly' }}

  # ============================================================================
  # Memory Leak Detection
  # ============================================================================
  memory-tests:
    name: ðŸ§  Memory Leak Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Valgrind
        run: sudo apt-get install -y valgrind

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev protobuf-compiler
          protoc --version
          echo "PROTOC=$(which protoc)" >> $GITHUB_ENV

      - name: Build tests
        run: cargo test --manifest-path apps/core/Cargo.toml --no-run

      - name: Run with Valgrind (sample tests)
        run: |
          TEST_BINARY=$(find apps/core/target/debug/deps -name "whytchat_core-*" -type f -executable | head -1)
          if [ -n "$TEST_BINARY" ]; then
            valgrind --leak-check=full --error-exitcode=1 $TEST_BINARY brain_tests --test-threads=1 2>&1 | head -100 || true
          fi
        continue-on-error: true

  # ============================================================================
  # Fuzzing
  # ============================================================================
  fuzz-tests:
    name: ðŸ”€ Fuzz Testing
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz
        continue-on-error: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev protobuf-compiler
          protoc --version
          echo "PROTOC=$(which protoc)" >> $GITHUB_ENV

      - name: Run fuzzing (short duration)
        run: |
          cd apps/core
          if [ -d "fuzz" ]; then
            cargo +nightly fuzz run fuzz_target_1 -- -max_total_time=60
          else
            echo "No fuzz targets found, skipping"
          fi
        continue-on-error: true

  # ============================================================================
  # Benchmark Tests
  # ============================================================================
  benchmarks:
    name: ðŸ“ˆ Benchmarks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev protobuf-compiler
          protoc --version
          echo "PROTOC=$(which protoc)" >> $GITHUB_ENV

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/
            ~/.cargo/git/
            apps/core/target/
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}

      - name: Run benchmarks
        run: cargo bench --manifest-path apps/core/Cargo.toml 2>&1 | tee benchmark-results.txt || true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results.txt
          retention-days: 30

  # ============================================================================
  # Dependency Check
  # ============================================================================
  dependency-check:
    name: ðŸ“¦ Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-outdated
        run: cargo install cargo-outdated

      - name: Check for outdated dependencies
        run: cargo outdated --manifest-path apps/core/Cargo.toml --exit-code 0 || true

      - name: Check for security vulnerabilities
        run: |
          cargo install cargo-audit
          cargo audit --manifest-path apps/core/Cargo.toml || true

  # ============================================================================
  # Nightly Report
  # ============================================================================
  nightly-report:
    name: ðŸ“‹ Nightly Report
    runs-on: ubuntu-latest
    needs: [full-test-matrix, memory-tests, benchmarks, dependency-check]
    if: always()

    steps:
      - name: Generate nightly report
        run: |
          echo "# ðŸŒ™ Nightly Build Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Category | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Full Test Matrix | ${{ needs.full-test-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Memory Tests | ${{ needs.memory-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Benchmarks | ${{ needs.benchmarks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Check | ${{ needs.dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
