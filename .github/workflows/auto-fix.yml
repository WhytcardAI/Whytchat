name: ðŸ”§ Auto-Fix on Failure

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

env:
  MAX_AUTO_FIX_ATTEMPTS: 2  # Prevent infinite loops

jobs:
  auto-fix:
    name: ðŸ©¹ Auto-Fix & Retry
    runs-on: ubuntu-latest
    # Only run if CI failed AND not already an auto-fix commit AND on pushable branches
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      !contains(github.event.workflow_run.head_commit.message, '[auto-fix]') &&
      !contains(github.event.workflow_run.head_commit.message, '[skip ci]') &&
      (github.event.workflow_run.head_branch == 'master' || 
       github.event.workflow_run.head_branch == 'main' ||
       startsWith(github.event.workflow_run.head_branch, 'fix/') ||
       startsWith(github.event.workflow_run.head_branch, 'feature/'))
    
    steps:
      - name: ðŸ“¥ Checkout failed branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” Check auto-fix attempt count
        id: check_attempts
        run: |
          # Count recent auto-fix commits (last 5 commits)
          AUTO_FIX_COUNT=$(git log --oneline -5 --grep="\[auto-fix\]" | wc -l)
          echo "Auto-fix commits in last 5: $AUTO_FIX_COUNT"
          
          if [ "$AUTO_FIX_COUNT" -ge "$MAX_AUTO_FIX_ATTEMPTS" ]; then
            echo "âš ï¸ Too many auto-fix attempts, stopping to prevent infinite loop"
            echo "should_continue=false" >> $GITHUB_OUTPUT
          else
            echo "should_continue=true" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ¦€ Setup Rust
        if: steps.check_attempts.outputs.should_continue == 'true'
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          components: rustfmt

      - name: ðŸ“¦ Setup Node.js
        if: steps.check_attempts.outputs.should_continue == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        if: steps.check_attempts.outputs.should_continue == 'true'
        run: npm ci

      - name: ðŸŽ¨ Auto-fix Rust formatting
        if: steps.check_attempts.outputs.should_continue == 'true'
        id: rust_fmt
        continue-on-error: true
        run: |
          cd apps/core
          cargo fmt
          echo "âœ… Rust formatting applied"

      - name: ðŸŽ¨ Auto-fix JS/TS linting
        if: steps.check_attempts.outputs.should_continue == 'true'
        id: js_fix
        continue-on-error: true
        run: |
          cd apps/desktop-ui
          npx eslint . --fix || true
          echo "âœ… ESLint fixes applied"

      - name: ðŸ” Check for changes
        if: steps.check_attempts.outputs.should_continue == 'true'
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No auto-fixable changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected:"
            git diff --stat
          fi

      - name: ðŸš€ Commit and push fixes directly
        if: steps.check_attempts.outputs.should_continue == 'true' && steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          git commit -m "ðŸ¤– [auto-fix] Formatting corrections

          Automatic fixes applied:
          - cargo fmt (Rust formatting)
          - eslint --fix (JS/TS linting)
          
          Triggered by: ${{ github.event.workflow_run.html_url }}
          
          [skip ci] will be removed on next human commit"
          
          git push origin ${{ github.event.workflow_run.head_branch }}
          
          echo "âœ… Fixes committed and pushed directly"

      - name: ðŸ”„ Re-trigger CI
        if: steps.check_attempts.outputs.should_continue == 'true' && steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Wait a moment for the push to be processed
          sleep 5
          
          # Trigger CI workflow manually
          gh workflow run ci.yml --ref ${{ github.event.workflow_run.head_branch }} || echo "CI will trigger automatically on push"
          
          echo "ðŸ”„ CI re-triggered"

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸ”§ Auto-Fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_attempts.outputs.should_continue }}" == "false" ]; then
            echo "âš ï¸ **Stopped**: Too many auto-fix attempts (max: $MAX_AUTO_FIX_ATTEMPTS)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Manual intervention required to fix remaining issues." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **Fixes applied and pushed directly**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Rust formatting (cargo fmt)" >> $GITHUB_STEP_SUMMARY
            echo "- JS/TS linting (eslint --fix)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "CI will re-run automatically." >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No auto-fixable issues found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The CI failure was caused by issues that cannot be auto-fixed:" >> $GITHUB_STEP_SUMMARY
            echo "- Compilation errors" >> $GITHUB_STEP_SUMMARY
            echo "- Test failures" >> $GITHUB_STEP_SUMMARY
            echo "- Logic errors" >> $GITHUB_STEP_SUMMARY
          fi
