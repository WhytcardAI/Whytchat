name: ðŸ”§ Auto-Fix on Failure

on:
  workflow_run:
    workflows: ["ðŸ”„ CI Pipeline"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    name: ðŸ©¹ Attempt Auto-Fix
    runs-on: ubuntu-latest
    # Only run if CI failed AND it's not already an auto-fix branch
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      !startsWith(github.event.workflow_run.head_branch, 'auto-fix/')
    
    steps:
      - name: ðŸ“¥ Checkout failed branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ¦€ Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          components: rustfmt, clippy

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸŽ¨ Auto-fix Rust formatting
        id: rust_fmt
        continue-on-error: true
        run: |
          cd apps/core
          if cargo fmt --check 2>/dev/null; then
            echo "rust_changed=false" >> $GITHUB_OUTPUT
          else
            cargo fmt
            echo "rust_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Rust formatting fixed"
          fi

      - name: ðŸŽ¨ Auto-fix JS/TS formatting & linting
        id: js_fix
        continue-on-error: true
        run: |
          cd apps/desktop-ui
          
          # Try eslint --fix
          if npx eslint . --fix 2>/dev/null; then
            echo "js_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… ESLint fixes applied"
          else
            echo "js_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ” Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No auto-fixable changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected:"
            git diff --stat
          fi

      - name: ðŸŒ¿ Create fix branch and PR
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create unique branch name
          BRANCH_NAME="auto-fix/${{ github.event.workflow_run.head_branch }}-$(date +%Y%m%d-%H%M%S)"
          
          # Create branch and commit
          git checkout -b "$BRANCH_NAME"
          git add -A
          git commit -m "ðŸ¤– Auto-fix: formatting and linting corrections

          Automatic fixes applied after CI failure on branch: ${{ github.event.workflow_run.head_branch }}
          
          Fixes applied:
          - Rust formatting (cargo fmt)
          - JavaScript linting (eslint --fix)
          
          Triggered by workflow run: ${{ github.event.workflow_run.html_url }}"
          
          # Push branch
          git push origin "$BRANCH_NAME"
          
          # Create PR
          gh pr create \
            --title "ðŸ¤– Auto-fix: CI corrections for ${{ github.event.workflow_run.head_branch }}" \
            --body "## ðŸ”§ Automatic Fixes Applied
          
          This PR was automatically created after a CI failure.
          
          ### Failed Workflow
          - **Branch:** \`${{ github.event.workflow_run.head_branch }}\`
          - **Run:** ${{ github.event.workflow_run.html_url }}
          - **Conclusion:** ${{ github.event.workflow_run.conclusion }}
          
          ### Fixes Applied
          - âœ… Rust formatting (\`cargo fmt\`)
          - âœ… JavaScript linting (\`eslint --fix\`)
          
          ### âš ï¸ Review Required
          Please review these automatic fixes before merging.
          Some fixes may not be appropriate for your use case.
          
          ---
          *This PR was created automatically by the Auto-Fix workflow.*" \
            --base "${{ github.event.workflow_run.head_branch }}" \
            --head "$BRANCH_NAME"
          
          echo "âœ… Auto-fix PR created successfully"

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸ”§ Auto-Fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust formatting | ${{ steps.rust_fmt.outputs.rust_changed == 'true' && 'âœ… Fixed' || 'âž– No changes' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| JS/TS linting | ${{ steps.js_fix.outputs.js_changed == 'true' && 'âœ… Fixed' || 'âž– No changes' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PR Created | ${{ steps.check_changes.outputs.has_changes == 'true' && 'âœ… Yes' || 'âŒ No (nothing to fix)' }} |" >> $GITHUB_STEP_SUMMARY
