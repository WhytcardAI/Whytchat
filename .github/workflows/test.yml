name: Test Suite

on:
  push:
    branches: [master, main, develop]
    paths:
      - "apps/core/**"
      - "apps/desktop-ui/**"
      - ".github/workflows/test.yml"
  pull_request:
    branches: [master, main]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: "0 2 * * *"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  ENCRYPTION_KEY: "01234567890123456789012345678901"

jobs:
  # ============================================================================
  # Rust Tests
  # ============================================================================
  rust-tests:
    name: ðŸ§ª Rust Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          # Uses version from apps/core/rust-toolchain.toml
          toolchain: "1.88.0"
          components: rustfmt, clippy

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev protobuf-compiler

      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew install gtk+3 protobuf

      - name: Install Protoc (Windows)
        if: runner.os == 'Windows'
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/
            ~/.cargo/git/
            apps/core/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Pin AWS SDK dependencies to Rust 1.88.0 compatible versions
        run: |
          cd apps/core
          cargo update aws-sdk-dynamodb@1.100.0 --precise 1.82.0
          cargo update aws-sdk-sso@1.90.0 --precise 1.76.0
          cargo update aws-sdk-ssooidc@1.92.0 --precise 1.79.0
          cargo update aws-sdk-sts@1.94.0 --precise 1.79.0
          cargo update home@0.5.12 --precise 0.5.11
        continue-on-error: true

      - name: Run all Rust tests
        run: cargo test --manifest-path apps/core/Cargo.toml -- --nocapture
        env:
          RUST_TEST_THREADS: 1
          ENCRYPTION_KEY: "01234567890123456789012345678901"

  # ============================================================================
  # Chaos Tests
  # ============================================================================
  chaos-tests:
    name: ðŸŒªï¸ Chaos Tests
    runs-on: ubuntu-latest
    needs: [rust-tests]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          # Uses version from apps/core/rust-toolchain.toml
          toolchain: "1.88.0"
          components: rustfmt, clippy

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev protobuf-compiler

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/
            ~/.cargo/git/
            apps/core/target/
          key: ${{ runner.os }}-cargo-chaos-${{ hashFiles('**/Cargo.lock') }}

      - name: Pin AWS SDK dependencies to compatible versions
        run: |
          cd apps/core
          cargo update aws-sdk-dynamodb@1.100.0 --precise 1.82.0
          cargo update aws-sdk-sso@1.90.0 --precise 1.76.0
          cargo update aws-sdk-ssooidc@1.92.0 --precise 1.79.0
          cargo update aws-sdk-sts@1.94.0 --precise 1.79.0
          cargo update home@0.5.12 --precise 0.5.11
        continue-on-error: true

      - name: Run chaos tests
        run: cargo test --manifest-path apps/core/Cargo.toml chaos_test -- --nocapture
        env:
          RUST_TEST_THREADS: 1
          ENCRYPTION_KEY: "01234567890123456789012345678901"
        continue-on-error: true

  # ============================================================================
  # E2E Tests
  # ============================================================================
  e2e-tests:
    name: ðŸŽ­ E2E Tests
    runs-on: ubuntu-latest
    needs: [rust-tests]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          # Uses version from apps/core/rust-toolchain.toml
          toolchain: "1.88.0"
          components: rustfmt, clippy

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev protobuf-compiler

      - name: Install npm dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Pin AWS SDK dependencies to compatible versions
        run: |
          cd apps/core
          cargo update aws-sdk-dynamodb@1.100.0 --precise 1.82.0
          cargo update aws-sdk-sso@1.90.0 --precise 1.76.0
          cargo update aws-sdk-ssooidc@1.92.0 --precise 1.79.0
          cargo update aws-sdk-sts@1.94.0 --precise 1.79.0
          cargo update home@0.5.12 --precise 0.5.11
        continue-on-error: true

      - name: Build application
        run: npm run tauri build
        continue-on-error: true
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          ENCRYPTION_KEY: "01234567890123456789012345678901"

      - name: Run E2E tests
        run: npm run test:e2e
        continue-on-error: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # ============================================================================
  # Stress Tests
  # ============================================================================
  stress-tests:
    name: ðŸ’ª Stress Tests
    runs-on: ubuntu-latest
    needs: [rust-tests]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run stress tests
        run: node apps/desktop-ui/tests/stress-test.cjs
        continue-on-error: true

  # ============================================================================
  # Test Summary
  # ============================================================================
  test-summary:
    name: ðŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [rust-tests, e2e-tests, chaos-tests, stress-tests]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ§ª Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Tests | ${{ needs.rust-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Chaos Tests | ${{ needs.chaos-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Stress Tests | ${{ needs.stress-tests.result }} |" >> $GITHUB_STEP_SUMMARY
