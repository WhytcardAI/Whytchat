name: Test Suite

on:
  push:
    branches: [master, main, develop]
    paths:
      - "apps/core/**"
      - "apps/desktop-ui/**"
      - ".github/workflows/test.yml"
  pull_request:
    branches: [master, main]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: "0 2 * * *"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # Unit Tests
  # ============================================================================
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        test-suite:
          - name: brain
            filter: brain_tests
          - name: database
            filter: database_tests
          - name: actors
            filter: actor_tests
          - name: encryption
            filter: encryption_tests
          - name: text_extract
            filter: text_extract_tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.80.0"

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/
            ~/.cargo/git/
            apps/core/target/
          key: ${{ runner.os }}-cargo-${{ matrix.test-suite.name }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Run ${{ matrix.test-suite.name }} tests
        run: cargo test --manifest-path apps/core/Cargo.toml ${{ matrix.test-suite.filter }} -- --nocapture
        env:
          RUST_TEST_THREADS: 1

  # ============================================================================
  # Integration Tests
  # ============================================================================
  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.80.0"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/
            ~/.cargo/git/
            apps/core/target/
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}

      - name: Run integration tests
        run: cargo test --manifest-path apps/core/Cargo.toml integration_tests -- --nocapture
        env:
          RUST_TEST_THREADS: 1

  # ============================================================================
  # Chaos Tests
  # ============================================================================
  chaos-tests:
    name: ðŸŒªï¸ Chaos Tests
    runs-on: ubuntu-latest
    needs: [integration-tests]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/
            ~/.cargo/git/
            apps/core/target/
          key: ${{ runner.os }}-cargo-chaos-${{ hashFiles('**/Cargo.lock') }}

      - name: Run chaos tests
        run: cargo test --manifest-path apps/core/Cargo.toml chaos_test -- --nocapture
        env:
          RUST_TEST_THREADS: 1
        continue-on-error: true

  # ============================================================================
  # E2E Tests
  # ============================================================================
  e2e-tests:
    name: ðŸŽ­ E2E Tests
    runs-on: ubuntu-latest
    needs: [integration-tests]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Install npm dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Build application
        run: npm run tauri build
        continue-on-error: true
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}

      - name: Run E2E tests
        run: npm run test:e2e
        continue-on-error: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # ============================================================================
  # Stress Tests
  # ============================================================================
  stress-tests:
    name: ðŸ’ª Stress Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run stress tests
        run: node apps/desktop-ui/tests/stress-test.cjs
        continue-on-error: true

  # ============================================================================
  # Test Summary
  # ============================================================================
  test-summary:
    name: ðŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, chaos-tests, stress-tests]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ§ª Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Chaos Tests | ${{ needs.chaos-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Stress Tests | ${{ needs.stress-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage" >> $GITHUB_STEP_SUMMARY
          echo "See Codecov for detailed coverage reports." >> $GITHUB_STEP_SUMMARY
