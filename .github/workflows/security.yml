name: Security

on:
  schedule:
    - cron: "0 2 * * 0" # Weekly on Sunday at 2 AM UTC
  workflow_dispatch:

jobs:
  # ============================================================================
  # Rust Security Audit
  # ============================================================================
  rust-audit:
    name: ðŸ¦€ Rust Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run audit
        run: cargo audit --manifest-path apps/core/Cargo.toml
        continue-on-error: true

      - name: Check unsafe code
        run: |
          echo "## Unsafe Code" >> $GITHUB_STEP_SUMMARY
          if grep -rn "unsafe" apps/core/src --include="*.rs" | grep -v "// safe:"; then
            echo "âš ï¸ Found unsafe blocks" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No unsafe code" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # NPM Audit
  # ============================================================================
  npm-audit:
    name: ðŸ“¦ NPM Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

  # ============================================================================
  # Secret Scanning
  # ============================================================================
  secrets:
    name: ðŸ” Secret Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for secrets
        run: |
          echo "## Secret Patterns Check" >> $GITHUB_STEP_SUMMARY
          FOUND=0
          
          # API keys
          if grep -rn "api[_-]\?key\s*[:=]\s*[\"'][^\"']\{20,\}[\"']" apps --include="*.rs" --include="*.js" --include="*.jsx" 2>/dev/null | grep -v test; then
            echo "âš ï¸ Potential API keys found" >> $GITHUB_STEP_SUMMARY
            FOUND=1
          fi
          
          # Passwords
          if grep -rn "password\s*[:=]\s*[\"'][^\"']\{8,\}[\"']" apps --include="*.rs" --include="*.js" 2>/dev/null | grep -v test | grep -v placeholder; then
            echo "âš ï¸ Potential passwords found" >> $GITHUB_STEP_SUMMARY
            FOUND=1
          fi
          
          if [ $FOUND -eq 0 ]; then
            echo "âœ… No secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # License Check
  # ============================================================================
  licenses:
    name: ðŸ“„ License Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-license
        run: cargo install cargo-license

      - name: Check licenses
        run: |
          echo "## Rust Licenses" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cargo license --manifest-path apps/core/Cargo.toml 2>&1 | head -30 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Check for GPL
          if cargo license --manifest-path apps/core/Cargo.toml --json 2>/dev/null | grep -i "GPL"; then
            echo "âš ï¸ GPL dependencies found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No GPL dependencies" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: ðŸ“‹ Summary
    runs-on: ubuntu-latest
    needs: [rust-audit, npm-audit, secrets, licenses]
    if: always()
    steps:
      - name: Report
        run: |
          echo "# ðŸ”’ Security Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Audit | ${{ needs.rust-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Audit | ${{ needs.npm-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secrets.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Licenses | ${{ needs.licenses.result }} |" >> $GITHUB_STEP_SUMMARY
