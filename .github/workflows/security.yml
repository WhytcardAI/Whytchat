name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: "0 2 * * 0"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # Rust Security
  # ============================================================================
  rust-security:
    name: ðŸ¦€ Rust Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit --manifest-path apps/core/Cargo.toml

      - name: Check for unsafe code
        run: |
          echo "## Unsafe Code Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if grep -r "unsafe" apps/core/src --include="*.rs"; then
            echo "âš ï¸ Found unsafe blocks - please review" >> $GITHUB_STEP_SUMMARY
            grep -rn "unsafe" apps/core/src --include="*.rs" | head -20 >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No unsafe blocks found" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Dependency Vulnerability Scan
  # ============================================================================
  dependency-scan:
    name: ðŸ“¦ Dependency Vulnerabilities
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install frontend dependencies
        run: npm ci
        working-directory: apps/desktop-ui

      - name: Run npm audit
        run: npm audit --audit-level=moderate || true
        working-directory: apps/desktop-ui

      - name: Generate audit report
        run: |
          echo "## NPM Audit Report" >> $GITHUB_STEP_SUMMARY
          npm audit --json > audit.json || true
          if [ -s audit.json ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat audit.json | head -100 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        working-directory: apps/desktop-ui

  # ============================================================================
  # Secret Scanning
  # ============================================================================
  secret-scan:
    name: ðŸ” Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install TruffleHog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
        continue-on-error: true

      - name: Run TruffleHog scan
        run: |
          trufflehog git file://. --only-verified --json > trufflehog-results.json 2>&1 || true
          if [ -s trufflehog-results.json ]; then
            echo "âš ï¸ Potential secrets found! Please review." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No verified secrets found" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Check for hardcoded secrets patterns
        run: |
          echo "## Hardcoded Secrets Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for common secret patterns
          FOUND=0

          if grep -rn "api[_-]?key\s*[:=]" apps --include="*.rs" --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" 2>/dev/null | grep -v test | head -5; then
            echo "âš ï¸ Found potential API key references" >> $GITHUB_STEP_SUMMARY
            FOUND=1
          fi

          if grep -rn "password\s*[:=]\s*[\"'][^\"']*[\"']" apps --include="*.rs" --include="*.js" --include="*.jsx" 2>/dev/null | grep -v test | head -5; then
            echo "âš ï¸ Found potential hardcoded passwords" >> $GITHUB_STEP_SUMMARY
            FOUND=1
          fi

          if [ $FOUND -eq 0 ]; then
            echo "âœ… No obvious hardcoded secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # SAST Analysis
  # ============================================================================
  sast-analysis:
    name: ðŸ” Static Application Security Testing
    runs-on: ubuntu-latest
    permissions:
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ============================================================================
  # License Compliance
  # ============================================================================
  license-check:
    name: ðŸ“„ License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-license
        run: cargo install cargo-license

      - name: Check Rust licenses
        run: |
          echo "## Rust Dependencies Licenses" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cargo license --manifest-path apps/core/Cargo.toml 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check for problematic licenses
        run: |
          cd apps/core
          cargo license --json 2>/dev/null | grep -i "GPL\|AGPL" && echo "âš ï¸ Found GPL/AGPL licensed dependencies" >> $GITHUB_STEP_SUMMARY || echo "âœ… No GPL/AGPL licenses found" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Security Report
  # ============================================================================
  security-report:
    name: ðŸ“‹ Security Report
    runs-on: ubuntu-latest
    needs: [rust-security, dependency-scan, secret-scan, license-check]
    if: always()

    steps:
      - name: Generate security report
        run: |
          echo "# ðŸ”’ Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Security Audit | ${{ needs.rust-security.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.rust-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | ${{ needs.secret-scan.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY
